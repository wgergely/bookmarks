<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <meta name="generator" content="sphinx-4.3.1, furo 2021.11.23"/>
        <title>bookmarks.images - Bookmarks 0.5.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?digest=7f0192ddeb2adecfbaa87ffbcf67d16358b30bc1" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?digest=0af69da206d614734f649b27d4cdc2dd6c31f41d" />
    
    


<style>
  body {
    --color-code-background: #ffffff;
  --color-code-foreground: black;
  --color-brand-primary: rgba(75, 180, 135, 1);
  --color-brand-content: rgba(75, 180, 135, 1);
  --color-api-name: rgba(0, 0, 0, 0.9);
  --color-api-pre-name: rgba(75, 180, 135, 0.75);
  --api-font-size: var(--font-size--normal);
  
  }
  body[data-theme="dark"] {
    --color-code-background: #232629;
  --color-code-foreground: #cccccc;
  --color-brand-primary: rgba(90, 200, 155, 1);
  --color-brand-content: rgba(90, 200, 155, 1);
  --color-api-name: rgba(255, 255, 255, 0.9);
  
  }
  @media (prefers-color-scheme: dark) {
    body:not([data-theme="light"]) {
      --color-code-background: #232629;
  --color-code-foreground: #cccccc;
  --color-brand-primary: rgba(90, 200, 155, 1);
  --color-brand-content: rgba(90, 200, 155, 1);
  --color-api-name: rgba(255, 255, 255, 0.9);
  
    }
  }
</style></head>
  <body>
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" />
      <line x1="4" y1="6" x2="20" y2="6" />
      <line x1="10" y1="12" x2="20" y2="12" />
      <line x1="6" y1="18" x2="20" y2="18" />
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">Bookmarks 0.5.0 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../../_static/icon.png" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="../../_static/icon_bw.png" alt="Dark Logo"/>
  </div>
  
  <span class="sidebar-brand-text">Bookmarks 0.5.0 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../bookmarks.html">Introduction</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../api.html">Python Modules Documentation</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/common.html">common</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/database.html">database</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/images.html">images</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/main.html">main</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/lists.html">lists</a></li>
</ul>
</li>
</ul>

</div>
</div>
      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <h1>Source code for bookmarks.images</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">"""The module defines :class:`.ImageCache`, a utility class used to store image and color data and</span>
<span class="sd">all other utility methods needed to create, load and store thumbnail images.</span>

<span class="sd">Custom, and generated item thumbnails are stored in the ``common.bookmark_cache_dir``.</span>
<span class="sd">The highest-level method to retrieve the thumbnail of a list item is :func:`get_thumbnail`.</span>
<span class="sd">This function relies on the ImageCache to retrieve data and will return an existing thumbnail image</span>
<span class="sd">or a suitable placeholder image (see :func:`get_placeholder_path`).</span>

<span class="sd">The lower level methods are to load image data are :meth:`ImageCache.get_pixmap` and</span>
<span class="sd">:meth:`ImageCache.get_image`.</span>

<span class="sd">Bookmarks uses OpenImageIO to generate thumbnails. See :meth:`ImageCache.oiio_make_thumbnail`.</span>
<span class="sd">To load an image using OpenImageIO as a QtGui.QImage see :func:`oiio_get_qimage`.</span>

<span class="sd">When loading resource images to use in the Gui use :meth:`.ImageCache.get_rsc_pixmap`.</span>


<span class="sd">"""</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">OpenImageIO</span>
<span class="kn">from</span> <span class="nn">PySide2</span> <span class="kn">import</span> <span class="n">QtWidgets</span><span class="p">,</span> <span class="n">QtGui</span><span class="p">,</span> <span class="n">QtCore</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">common</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">log</span>

<span class="n">QT_IMAGE_FORMATS</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="o">.</span><span class="n">data</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf8'</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QImageReader</span><span class="o">.</span><span class="n">supportedImageFormats</span><span class="p">()}</span>

<span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>

<span class="n">BufferType</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">UserRole</span>
<span class="n">PixmapType</span> <span class="o">=</span> <span class="n">BufferType</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">ImageType</span> <span class="o">=</span> <span class="n">PixmapType</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">IconType</span> <span class="o">=</span> <span class="n">ImageType</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">ResourcePixmapType</span> <span class="o">=</span> <span class="n">IconType</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">ColorType</span> <span class="o">=</span> <span class="n">ResourcePixmapType</span> <span class="o">+</span> <span class="mi">1</span>

<span class="n">accepted_codecs</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'h.264'</span><span class="p">,</span> <span class="s1">'h264'</span><span class="p">,</span> <span class="s1">'mpeg-4'</span><span class="p">,</span> <span class="s1">'mpeg4'</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">init_imagecache</span><span class="p">():</span>
    <span class="n">common</span><span class="o">.</span><span class="n">oiio_cache</span> <span class="o">=</span> <span class="n">OpenImageIO</span><span class="o">.</span><span class="n">ImageCache</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">common</span><span class="o">.</span><span class="n">oiio_cache</span><span class="o">.</span><span class="n">attribute</span><span class="p">(</span><span class="s1">'max_memory_MB'</span><span class="p">,</span> <span class="mf">4096.0</span><span class="p">)</span>
    <span class="n">common</span><span class="o">.</span><span class="n">oiio_cache</span><span class="o">.</span><span class="n">attribute</span><span class="p">(</span><span class="s1">'max_open_files'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">common</span><span class="o">.</span><span class="n">oiio_cache</span><span class="o">.</span><span class="n">attribute</span><span class="p">(</span><span class="s1">'trust_file_extensions'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">common</span><span class="o">.</span><span class="n">oiio_cache</span><span class="o">.</span><span class="n">attribute</span><span class="p">(</span><span class="s1">'forcefloat'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">common</span><span class="o">.</span><span class="n">image_resource_list</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">common</span><span class="o">.</span><span class="n">GuiResource</span><span class="p">:</span> <span class="p">[],</span>
        <span class="n">common</span><span class="o">.</span><span class="n">ThumbnailResource</span><span class="p">:</span> <span class="p">[],</span>
        <span class="n">common</span><span class="o">.</span><span class="n">FormatResource</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>
    <span class="n">common</span><span class="o">.</span><span class="n">image_resource_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">common</span><span class="o">.</span><span class="n">image_cache</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">BufferType</span><span class="p">:</span> <span class="p">{},</span>
        <span class="n">PixmapType</span><span class="p">:</span> <span class="p">{},</span>
        <span class="n">ImageType</span><span class="p">:</span> <span class="p">{},</span>
        <span class="n">IconType</span><span class="p">:</span> <span class="p">{},</span>
        <span class="n">ResourcePixmapType</span><span class="p">:</span> <span class="p">{},</span>
        <span class="n">ColorType</span><span class="p">:</span> <span class="p">{},</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">init_resources</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">_source</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">((</span><span class="n">common</span><span class="o">.</span><span class="n">get_rsc</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span>
                       <span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">GuiResource</span><span class="p">,</span> <span class="n">common</span><span class="o">.</span><span class="n">ThumbnailResource</span><span class="p">,</span> <span class="n">common</span><span class="o">.</span><span class="n">FormatResource</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">_entry</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">scandir</span><span class="p">(</span><span class="n">_source</span><span class="p">):</span>
            <span class="n">common</span><span class="o">.</span><span class="n">image_resource_list</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_entry</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">init_pixel_ratio</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s1">'`init_pixel_ratio()` was called before a QApplication was created.'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">app</span> <span class="ow">and</span> <span class="n">common</span><span class="o">.</span><span class="n">pixel_ratio</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">common</span><span class="o">.</span><span class="n">pixel_ratio</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">primaryScreen</span><span class="p">()</span><span class="o">.</span><span class="n">devicePixelRatio</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">common</span><span class="o">.</span><span class="n">pixel_ratio</span> <span class="o">=</span> <span class="mf">1.0</span>


<div class="viewcode-block" id="get_thumbnail"><a class="viewcode-back" href="../../api/images.html#bookmarks.images.get_thumbnail">[docs]</a><span class="k">def</span> <span class="nf">get_thumbnail</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">common</span><span class="o">.</span><span class="n">thumbnail_size</span><span class="p">,</span>
                  <span class="n">fallback_thumb</span><span class="o">=</span><span class="s1">'placeholder'</span><span class="p">,</span>
                  <span class="n">get_path</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">"""Get the thumbnail of a list item.</span>

<span class="sd">    When an item is missing a bespoke cached thumbnail file, we will try to load</span>
<span class="sd">    a fallback image instead. For files, this will be an image associated with</span>
<span class="sd">    the file-format, or for asset and bookmark items, we will look in</span>
<span class="sd">    bookmark's, then the job's root folder to see if we can find a</span>
<span class="sd">    `thumbnail.png` file. When all lookup fails we'll return the provided</span>
<span class="sd">    `fallback_thumb`.</span>

<span class="sd">    See also :func:`get_cached_thumbnail_path()` for a lower level method used</span>
<span class="sd">    to find a cached image file.</span>

<span class="sd">    Args:</span>
<span class="sd">        server (str):        A server name.</span>
<span class="sd">        job (str):           A job name.</span>
<span class="sd">        root (str):          A root folder name.</span>
<span class="sd">        source (str):        Full file path of source item.</span>
<span class="sd">        size (int):              The size of the thumbnail image in pixels.</span>
<span class="sd">        fallback_thumb(str): A fallback thumbnail image.</span>
<span class="sd">        get_path (bool):         Returns a path instead of a QPixmap if set to `True`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple:                   `(QPixmap, QColor)`, or `(None, None)`.</span>
<span class="sd">        str:                 Path to the thumbnail file when `get_path=True`.</span>


<span class="sd">    """</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">((</span><span class="n">server</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">source</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">get_path</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">proxy</span><span class="p">):</span>
        <span class="n">thumbnail_path</span> <span class="o">=</span> <span class="n">get_cached_thumbnail_path</span><span class="p">(</span>
            <span class="n">server</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="n">proxy</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
            <span class="n">pixmap</span> <span class="o">=</span> <span class="n">ImageCache</span><span class="o">.</span><span class="n">get_pixmap</span><span class="p">(</span><span class="n">thumbnail_path</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pixmap</span> <span class="ow">or</span> <span class="n">pixmap</span><span class="o">.</span><span class="n">isNull</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">thumbnail_path</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">ImageCache</span><span class="o">.</span><span class="n">get_color</span><span class="p">(</span><span class="n">thumbnail_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">color</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">thumbnail_path</span><span class="p">,</span> <span class="n">pixmap</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">thumbnail_path</span><span class="p">,</span> <span class="n">pixmap</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>

    <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="n">common</span><span class="o">.</span><span class="n">pixel_ratio</span><span class="p">))</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>

    <span class="c1"># In the simplest of all cases, the source has a bespoke thumbnail saved we</span>
    <span class="c1"># can return outright.</span>

    <span class="n">thumbnail_path</span><span class="p">,</span> <span class="n">pixmap</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pixmap</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pixmap</span><span class="o">.</span><span class="n">isNull</span><span class="p">()</span> <span class="ow">and</span> <span class="n">get_path</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">thumbnail_path</span>
    <span class="k">if</span> <span class="n">pixmap</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pixmap</span><span class="o">.</span><span class="n">isNull</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">pixmap</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>

    <span class="c1"># If this item is an un-collapsed sequence item, the sequence</span>
    <span class="c1"># might have a thumbnail instead.</span>
    <span class="n">thumbnail_path</span><span class="p">,</span> <span class="n">pixmap</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pixmap</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pixmap</span><span class="o">.</span><span class="n">isNull</span><span class="p">()</span> <span class="ow">and</span> <span class="n">get_path</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">thumbnail_path</span>
    <span class="k">if</span> <span class="n">pixmap</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pixmap</span><span class="o">.</span><span class="n">isNull</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">pixmap</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>

    <span class="c1"># If the item refers to a folder, eg. an asset or a bookmark item,  we'll</span>
    <span class="c1"># check for a 'thumbnail.{ext}' file in the folder's root and if this fails,</span>
    <span class="c1"># we will check the job folder. If both fails will we proceed to load a</span>
    <span class="c1"># placeholder thumbnail.</span>
    <span class="k">if</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QFileInfo</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="o">.</span><span class="n">isDir</span><span class="p">():</span>
        <span class="n">_hash</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_hash</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

        <span class="n">thumb_path</span> <span class="o">=</span> <span class="n">check_for_thumbnail_image</span><span class="p">(</span><span class="s1">'/'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">thumb_path</span><span class="p">:</span>
            <span class="n">thumb_path</span> <span class="o">=</span> <span class="n">check_for_thumbnail_image</span><span class="p">(</span><span class="s1">'/'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">thumb_path</span><span class="p">:</span>
            <span class="n">pixmap</span> <span class="o">=</span> <span class="n">ImageCache</span><span class="o">.</span><span class="n">get_pixmap</span><span class="p">(</span>
                <span class="n">thumb_path</span><span class="p">,</span>
                <span class="n">size</span><span class="p">,</span>
                <span class="nb">hash</span><span class="o">=</span><span class="n">_hash</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">pixmap</span> <span class="ow">and</span> <span class="n">get_path</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">thumb_path</span>
            <span class="k">if</span> <span class="n">pixmap</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="n">ImageCache</span><span class="o">.</span><span class="n">get_color</span><span class="p">(</span><span class="n">thumb_path</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">pixmap</span><span class="p">,</span> <span class="n">color</span>

    <span class="c1"># Let's load a placeholder if there's no generated thumbnail or</span>
    <span class="c1"># thumbnail file present in the source's root.</span>
    <span class="n">thumb_path</span> <span class="o">=</span> <span class="n">get_placeholder_path</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">fallback_thumb</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
        <span class="n">pixmap</span> <span class="o">=</span> <span class="n">ImageCache</span><span class="o">.</span><span class="n">get_pixmap</span><span class="p">(</span><span class="n">thumb_path</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pixmap</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pixmap</span><span class="o">.</span><span class="n">isNull</span><span class="p">()</span> <span class="ow">and</span> <span class="n">get_path</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">thumb_path</span>

    <span class="k">if</span> <span class="n">pixmap</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pixmap</span><span class="o">.</span><span class="n">isNull</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">pixmap</span><span class="p">,</span> <span class="kc">None</span>

    <span class="c1"># In theory, we will never get here as get_placeholder_path will always</span>
    <span class="c1"># return a valid pixmap</span>
    <span class="k">if</span> <span class="n">get_path</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">wait_for_lock</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">source</span> <span class="o">+</span> <span class="s1">'.lock'</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mf">0.1</span>


<div class="viewcode-block" id="get_oiio_extensions"><a class="viewcode-back" href="../../api/images.html#bookmarks.images.get_oiio_extensions">[docs]</a><span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">4194304</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_oiio_extensions</span><span class="p">():</span>
    <span class="sd">"""Returns a list of extensions accepted by OpenImageIO.</span>

<span class="sd">    """</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">OpenImageIO</span><span class="o">.</span><span class="n">get_string_attribute</span><span class="p">(</span><span class="s1">'extension_list'</span><span class="p">)</span>
    <span class="n">extensions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">':'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">';'</span><span class="p">)]:</span>
        <span class="n">extensions</span> <span class="o">+=</span> <span class="n">e</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">','</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">extensions</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_oiio_namefilters"><a class="viewcode-back" href="../../api/images.html#bookmarks.images.get_oiio_namefilters">[docs]</a><span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">4194304</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_oiio_namefilters</span><span class="p">():</span>
    <span class="sd">"""Gets all accepted formats from the oiio build as a namefilter list.</span>
<span class="sd">    Use the return value on the QFileDialog.setNameFilters() method.</span>

<span class="sd">    """</span>
    <span class="n">extension_list</span> <span class="o">=</span> <span class="n">OpenImageIO</span><span class="o">.</span><span class="n">get_string_attribute</span><span class="p">(</span><span class="s1">'extension_list'</span><span class="p">)</span>
    <span class="n">namefilters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">exts</span> <span class="ow">in</span> <span class="n">extension_list</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">';'</span><span class="p">):</span>
        <span class="n">exts</span> <span class="o">=</span> <span class="n">exts</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">':'</span><span class="p">)</span>
        <span class="n">_exts</span> <span class="o">=</span> <span class="n">exts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">','</span><span class="p">)</span>
        <span class="n">e</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'*.</span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">_exts</span><span class="p">]</span>
        <span class="n">namefilter</span> <span class="o">=</span> <span class="s1">'</span><span class="si">{}</span><span class="s1"> files (</span><span class="si">{}</span><span class="s1">)'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="s1">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">namefilters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">namefilter</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_e</span> <span class="ow">in</span> <span class="n">_exts</span><span class="p">:</span>
            <span class="n">arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span>

    <span class="n">allfiles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'*.</span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">arr</span><span class="p">]</span>
    <span class="n">allfiles</span> <span class="o">=</span> <span class="s1">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">allfiles</span><span class="p">)</span>
    <span class="n">allfiles</span> <span class="o">=</span> <span class="s1">'All files (</span><span class="si">{}</span><span class="s1">)'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">allfiles</span><span class="p">)</span>
    <span class="n">namefilters</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">allfiles</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">';;'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">namefilters</span><span class="p">)</span></div>


<div class="viewcode-block" id="check_for_thumbnail_image"><a class="viewcode-back" href="../../api/images.html#bookmarks.images.check_for_thumbnail_image">[docs]</a><span class="k">def</span> <span class="nf">check_for_thumbnail_image</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
    <span class="sd">"""Utility method for checking for the existence of a `thumbnail.ext` file</span>
<span class="sd">    in a source folder.</span>

<span class="sd">    Args:</span>
<span class="sd">        source (str):   Path to folder.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str:    The path to the thumbnail file or `None` if not found.</span>

<span class="sd">    """</span>
    <span class="c1"># We'll rely on Qt5 to load the image without OpenImageIO so we'll query</span>
    <span class="c1"># supportedImageFormats() to get the list of valid image formats.</span>
    <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">QT_IMAGE_FORMATS</span><span class="p">:</span>
        <span class="n">file_info</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QFileInfo</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s1">/thumbnail.</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_info</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">file_info</span><span class="o">.</span><span class="n">filePath</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="load_thumbnail_from_image"><a class="viewcode-back" href="../../api/images.html#bookmarks.images.load_thumbnail_from_image">[docs]</a><span class="nd">@common</span><span class="o">.</span><span class="n">error</span>
<span class="nd">@common</span><span class="o">.</span><span class="n">debug</span>
<span class="k">def</span> <span class="nf">load_thumbnail_from_image</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">"""Loads an image from a given image path and cache to `ImageCache` to be</span>
<span class="sd">    associated with `source`.</span>

<span class="sd">    """</span>
    <span class="n">thumbnail_path</span> <span class="o">=</span> <span class="n">get_cached_thumbnail_path</span><span class="p">(</span>
        <span class="n">server</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="n">proxy</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QFileInfo</span><span class="p">(</span><span class="n">thumbnail_path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QFile</span><span class="p">(</span><span class="n">thumbnail_path</span><span class="p">)</span><span class="o">.</span><span class="n">remove</span><span class="p">():</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s1">'Failed to remove existing thumbnail file.'</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">ImageCache</span><span class="o">.</span><span class="n">oiio_make_thumbnail</span><span class="p">(</span>
        <span class="n">image</span><span class="p">,</span>
        <span class="n">thumbnail_path</span><span class="p">,</span>
        <span class="n">common</span><span class="o">.</span><span class="n">thumbnail_size</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">'Failed to make thumbnail.'</span><span class="p">)</span>

    <span class="n">ImageCache</span><span class="o">.</span><span class="n">flush</span><span class="p">(</span><span class="n">thumbnail_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_cached_thumbnail_path"><a class="viewcode-back" href="../../api/images.html#bookmarks.images.get_cached_thumbnail_path">[docs]</a><span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">4194304</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_cached_thumbnail_path</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">"""Returns the path to a cached thumbnail file.</span>

<span class="sd">    When `proxy` is set to `True` or the source file is a sequence, we will use</span>
<span class="sd">    the sequence's first item as our thumbnail source.</span>

<span class="sd">    Args:</span>
<span class="sd">        server (str):       The `server` segment of the file path.</span>
<span class="sd">        job (str):          The `job` segment of the file path.</span>
<span class="sd">        root (str):         The `root` segment of the file path.</span>
<span class="sd">        source (str):       The full file path.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str:                The resolved thumbnail path.</span>

<span class="sd">    """</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
        <span class="n">common</span><span class="o">.</span><span class="n">check_type</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">proxy</span> <span class="ow">or</span> <span class="n">common</span><span class="o">.</span><span class="n">is_collapsed</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">proxy_path</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_hash</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'.'</span> <span class="o">+</span> <span class="n">common</span><span class="o">.</span><span class="n">thumbnail_format</span>
    <span class="k">return</span> <span class="n">server</span> <span class="o">+</span> <span class="s1">'/'</span> <span class="o">+</span> <span class="n">job</span> <span class="o">+</span> <span class="s1">'/'</span> <span class="o">+</span> <span class="n">root</span> <span class="o">+</span> <span class="s1">'/'</span> <span class="o">+</span> <span class="n">common</span><span class="o">.</span><span class="n">bookmark_cache_dir</span> <span class="o">+</span> <span class="s1">'/'</span> <span class="o">+</span> <span class="n">name</span></div>


<div class="viewcode-block" id="get_placeholder_path"><a class="viewcode-back" href="../../api/images.html#bookmarks.images.get_placeholder_path">[docs]</a><span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">4194304</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_placeholder_path</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">fallback</span><span class="p">):</span>
    <span class="sd">"""Returns an image path used to represent an item.</span>

<span class="sd">    In absence of a custom user, or generated thumbnail, we'll try and find one based on</span>
<span class="sd">    the file's format extension.</span>

<span class="sd">    Args:</span>
<span class="sd">        file_path (str): Path to a file or folder.</span>
<span class="sd">        fallback (str): An image to use if no suitable placeholder is found.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Path to the placeholder image.</span>

<span class="sd">    """</span>
    <span class="n">common</span><span class="o">.</span><span class="n">check_type</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">common</span><span class="o">.</span><span class="n">get_rsc</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">common</span><span class="o">.</span><span class="n">thumbnail_format</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>

    <span class="n">file_info</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QFileInfo</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="n">file_info</span><span class="o">.</span><span class="n">suffix</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">common</span><span class="o">.</span><span class="n">image_resource_list</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">FormatResource</span><span class="p">]:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">FormatResource</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fallback</span> <span class="ow">in</span> <span class="n">common</span><span class="o">.</span><span class="n">image_resource_list</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">FormatResource</span><span class="p">]:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">FormatResource</span><span class="p">,</span> <span class="n">fallback</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">fallback</span> <span class="ow">in</span> <span class="n">common</span><span class="o">.</span><span class="n">image_resource_list</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">ThumbnailResource</span><span class="p">]:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">ThumbnailResource</span><span class="p">,</span> <span class="n">fallback</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">fallback</span> <span class="ow">in</span> <span class="n">common</span><span class="o">.</span><span class="n">image_resource_list</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">GuiResource</span><span class="p">]:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">GuiResource</span><span class="p">,</span> <span class="n">fallback</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">GuiResource</span><span class="p">,</span> <span class="s1">'placeholder'</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>



<div class="viewcode-block" id="oiio_get_buf"><a class="viewcode-back" href="../../api/images.html#bookmarks.images.oiio_get_buf">[docs]</a><span class="k">def</span> <span class="nf">oiio_get_buf</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">"""Check and load a source image with OpenImageIO's format reader.</span>


<span class="sd">    Args:</span>
<span class="sd">        source (str):       Path to an OpenImageIO compatible image file.</span>
<span class="sd">        hash (str):         Specify the hash manually, otherwise will be generated.</span>
<span class="sd">        force (bool):       When `true`, forces the buffer to be re-cached.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ImageBuf: An `ImageBuf` instance or `None` if the image cannot be read.</span>

<span class="sd">    """</span>
    <span class="n">common</span><span class="o">.</span><span class="n">check_type</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">hash</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">hash</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_hash</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> <span class="n">ImageCache</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="nb">hash</span><span class="p">,</span> <span class="n">BufferType</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ImageCache</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="nb">hash</span><span class="p">,</span> <span class="n">BufferType</span><span class="p">)</span>

    <span class="c1"># We use the extension to initiate an ImageInput with a format</span>
    <span class="c1"># which in turn is used to check the source's validity</span>
    <span class="k">if</span> <span class="s1">'.'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ext</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">get_oiio_extensions</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">OpenImageIO</span><span class="o">.</span><span class="n">ImageInput</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">i</span><span class="o">.</span><span class="n">valid_file</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
        <span class="n">i</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># If all went well, we can initiate an ImageBuf</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">OpenImageIO</span><span class="o">.</span><span class="n">ImageSpec</span><span class="p">()</span>
    <span class="n">config</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">OpenImageIO</span><span class="o">.</span><span class="n">TypeDesc</span><span class="p">(</span><span class="n">OpenImageIO</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">)</span>

    <span class="n">buf</span> <span class="o">=</span> <span class="n">OpenImageIO</span><span class="o">.</span><span class="n">ImageBuf</span><span class="p">()</span>
    <span class="n">buf</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">buf</span><span class="o">.</span><span class="n">has_error</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">geterror</span><span class="p">())</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">ImageCache</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="nb">hash</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">BufferType</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">buf</span></div>


<div class="viewcode-block" id="oiio_get_qimage"><a class="viewcode-back" href="../../api/images.html#bookmarks.images.oiio_get_qimage">[docs]</a><span class="k">def</span> <span class="nf">oiio_get_qimage</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">buf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">"""Load the pixel data using OpenImageIO and return it as a</span>
<span class="sd">    `RGBA8888` / `RGB888` QImage.</span>

<span class="sd">    Args:</span>
<span class="sd">        source (str):                 Path to an OpenImageIO readable image.</span>
<span class="sd">        buf (OpenImageIO.ImageBuf):     When buf is valid ImageBuf instance it will be used</span>
<span class="sd">                                        as the source instead of `source`. Defaults to `None`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        QImage: An QImage instance or `None` if the image/source is invalid.</span>

<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">buf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">oiio_get_buf</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">buf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="n">spec</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">spec</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">nchannels</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">nchannels</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">OpenImageIO</span><span class="o">.</span><span class="n">ImageBufAlgo</span><span class="o">.</span><span class="n">channels</span><span class="p">(</span>
            <span class="n">buf</span><span class="p">,</span>
            <span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">channelnames</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spec</span><span class="o">.</span><span class="n">channelnames</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spec</span><span class="o">.</span><span class="n">channelnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="p">(</span><span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">int</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">nchannels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">channelindex</span><span class="p">(</span><span class="s1">'A'</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">OpenImageIO</span><span class="o">.</span><span class="n">ImageBufAlgo</span><span class="o">.</span><span class="n">channels</span><span class="p">(</span>
                <span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'A'</span><span class="p">),</span> <span class="p">(</span><span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'A'</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">OpenImageIO</span><span class="o">.</span><span class="n">ImageBufAlgo</span><span class="o">.</span><span class="n">channels</span><span class="p">(</span>
                <span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">),</span> <span class="p">(</span><span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">))</span>

    <span class="n">np_arr</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">get_pixels</span><span class="p">(</span><span class="n">OpenImageIO</span><span class="o">.</span><span class="n">UINT8</span><span class="p">)</span>
    <span class="c1"># np_arr = (np_arr / (1.0 / 255.0)).astype(np.uint8)</span>

    <span class="k">if</span> <span class="n">np_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">_format</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QImage</span><span class="o">.</span><span class="n">Format_Grayscale8</span>
    <span class="k">if</span> <span class="n">np_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">_format</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QImage</span><span class="o">.</span><span class="n">Format_Invalid</span>
    <span class="k">elif</span> <span class="n">np_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">_format</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QImage</span><span class="o">.</span><span class="n">Format_RGB888</span>
    <span class="k">elif</span> <span class="n">np_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">_format</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QImage</span><span class="o">.</span><span class="n">Format_RGBA8888</span>
    <span class="k">elif</span> <span class="n">np_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">_format</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QImage</span><span class="o">.</span><span class="n">Format_Invalid</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QImage</span><span class="p">(</span>
        <span class="n">np_arr</span><span class="p">,</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">spec</span><span class="o">.</span><span class="n">nchannels</span><span class="p">,</span>  <span class="c1"># scanlines</span>
        <span class="n">_format</span>
    <span class="p">)</span>
    <span class="n">image</span><span class="o">.</span><span class="n">setDevicePixelRatio</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">pixel_ratio</span><span class="p">)</span>

    <span class="c1"># As soon as the numpy array is garbage collected, the data for QImage becomes</span>
    <span class="c1"># unusable and Qt5 crashes. This could possibly be a bug, I would expect,</span>
    <span class="c1"># the data to be copied automatically, but by making a copy</span>
    <span class="c1"># the numpy array can safely be GC'd</span>
    <span class="k">return</span> <span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>


<div class="viewcode-block" id="ImageCache"><a class="viewcode-back" href="../../api/images.html#bookmarks.images.ImageCache">[docs]</a><span class="k">class</span> <span class="nc">ImageCache</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QObject</span><span class="p">):</span>
    <span class="sd">"""Utility class for storing, and accessing image data.</span>

<span class="sd">    The stored data is associated with a `type` and `hash` (see :func:`.common.get_hash`) and</span>
<span class="sd">    `size`. This means single source image can have multiple QPixmap and QImage entries as</span>
<span class="sd">    various sizes are requested via the cache.</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        common.image_cache[cache_type][hash][size] = pixmap</span>

<span class="sd">    Whilst the cache provides a :meth:`.value` and :meth:`setValue`, and :meth:`contains` methods,</span>
<span class="sd">    loading is usually done using :meth:`get_image` and :meth:`get_pixmap`.</span>

<span class="sd">    When loading resource images to use in the Gui use :meth:`get_rsc_pixmap`.</span>

<span class="sd">    """</span>

<div class="viewcode-block" id="ImageCache.flush"><a class="viewcode-back" href="../../api/images.html#bookmarks.images.ImageCache.flush">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
        <span class="sd">"""Flushes all values associated with a given source from the image cache.</span>

<span class="sd">        """</span>
        <span class="nb">hash</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_hash</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">common</span><span class="o">.</span><span class="n">image_cache</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hash</span> <span class="ow">in</span> <span class="n">common</span><span class="o">.</span><span class="n">image_cache</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                <span class="k">del</span> <span class="n">common</span><span class="o">.</span><span class="n">image_cache</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="nb">hash</span><span class="p">]</span></div>

<div class="viewcode-block" id="ImageCache.get_image"><a class="viewcode-back" href="../../api/images.html#bookmarks.images.ImageCache.get_image">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_image</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">oiio</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">"""Loads, resizes `source` as a QImage and stores it for later use.</span>

<span class="sd">        When size is '-1' the full image will be loaded without resizing.</span>

<span class="sd">        The resource will be stored as QImage instance at</span>
<span class="sd">        `common.image_cache[ImageType][hash]`. The hash value is generated by default</span>
<span class="sd">        using `source`'s value but this can be overwritten by explicitly</span>
<span class="sd">        setting `hash`.</span>

<span class="sd">        Args:</span>
<span class="sd">            source (str):       Path to an OpenImageIO compliant image file.</span>
<span class="sd">            size (int):         The size of the requested image.</span>
<span class="sd">            hash (str):         Use this hash key instead source to store the data.</span>
<span class="sd">            force (bool):       Force reloads the image from source.</span>
<span class="sd">            oiio (bool):        Use OpenImageIO to load the image data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            QImage: The loaded and resized QImage, or `None` if loading fails.</span>

<span class="sd">        """</span>
        <span class="n">common</span><span class="o">.</span><span class="n">check_type</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">oiio_get_buf</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">spec</span><span class="p">()</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">spec</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">height</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">hash</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">hash</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_hash</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

        <span class="c1"># Check the cache and return the previously stored value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> <span class="bp">cls</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="nb">hash</span><span class="p">,</span> <span class="n">ImageType</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="nb">hash</span><span class="p">,</span> <span class="n">ImageType</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>

        <span class="c1"># If not yet stored, load and save the data</span>
        <span class="n">wait_for_lock</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">oiio_get_buf</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="nb">hash</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">buf</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">oiio</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">oiio_get_qimage</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QImage</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
            <span class="n">image</span><span class="o">.</span><span class="n">setDevicePixelRatio</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">pixel_ratio</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">isNull</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Let's resize, but only if the source is bigger than the requested size</span>
        <span class="c1"># spec = buf.spec()</span>
        <span class="c1"># msize = max((spec.width, spec.height))</span>

        <span class="c1"># if size != -1 and size &lt; msize:</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">resize_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">isNull</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># ...and store</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="nb">hash</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">ImageType</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image</span></div>

<div class="viewcode-block" id="ImageCache.get_pixmap"><a class="viewcode-back" href="../../api/images.html#bookmarks.images.ImageCache.get_pixmap">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_pixmap</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">oiio</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">"""Loads, resizes `source` as a QPixmap and stores it for later use.</span>

<span class="sd">        When size is '-1' the full image will be loaded without resizing.</span>

<span class="sd">        The resource will be stored as a QPixmap instance and saved to</span>
<span class="sd">        :attr:`common.image_cache[PixmapType][hash]`. The hash value is generated using</span>
<span class="sd">        ``source`` but this can be overwritten by explicitly setting ``hash``.</span>

<span class="sd">        Note:</span>
<span class="sd">            It is not possible to call this method outside the main gui thread.</span>
<span class="sd">            Use :meth:`get_image` instead. This method is backed by :meth:`get_image`</span>
<span class="sd">            anyway.</span>

<span class="sd">        Args:</span>
<span class="sd">            source (str):   Path to an image file.</span>
<span class="sd">            size (int):     The size of the requested image.</span>
<span class="sd">            hash (str):     Use this hash key instead of a source's hash value to store the data.</span>
<span class="sd">            force (bool):   Force reloads the pixmap.</span>
<span class="sd">            oiio (bool):    Use OpenImageIO to load the image, instead of Qt.</span>

<span class="sd">        Returns:</span>
<span class="sd">            QPixmap: The loaded and resized QPixmap, or `None`.</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QGuiApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s1">'Cannot create QPixmaps without a gui application.'</span><span class="p">)</span>

        <span class="n">common</span><span class="o">.</span><span class="n">check_type</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

        <span class="n">app</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">app</span> <span class="ow">and</span> <span class="n">app</span><span class="o">.</span><span class="n">thread</span><span class="p">()</span> <span class="o">!=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QThread</span><span class="o">.</span><span class="n">currentThread</span><span class="p">():</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s1">'Pixmaps can only be initiated in the main gui thread.'</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">oiio_get_buf</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">spec</span><span class="p">()</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">spec</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">height</span><span class="p">))</span>

        <span class="c1"># Check the cache and return the previously stored value if exists</span>
        <span class="k">if</span> <span class="nb">hash</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">hash</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_hash</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="n">contains</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="nb">hash</span><span class="p">,</span> <span class="n">PixmapType</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> <span class="n">contains</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="nb">hash</span><span class="p">,</span> <span class="n">PixmapType</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>

        <span class="c1"># We'll load a cache a QImage to use as the basis for the QPixmap. This</span>
        <span class="c1"># is because of how the thread affinity of QPixmaps don't permit use</span>
        <span class="c1"># outside the main gui thread</span>
        <span class="n">image</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_image</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="nb">hash</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">,</span> <span class="n">oiio</span><span class="o">=</span><span class="n">oiio</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">image</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">pixmap</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPixmap</span><span class="p">()</span>
        <span class="n">pixmap</span><span class="o">.</span><span class="n">setDevicePixelRatio</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">pixel_ratio</span><span class="p">)</span>
        <span class="n">pixmap</span><span class="o">.</span><span class="n">convertFromImage</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">ColorOnly</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pixmap</span><span class="o">.</span><span class="n">isNull</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="nb">hash</span><span class="p">,</span> <span class="n">pixmap</span><span class="p">,</span> <span class="n">PixmapType</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pixmap</span></div>

<div class="viewcode-block" id="ImageCache.contains"><a class="viewcode-back" href="../../api/images.html#bookmarks.images.ImageCache.contains">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">contains</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_hash</span><span class="p">,</span> <span class="n">cache_type</span><span class="p">):</span>
        <span class="sd">"""Checks if the given hash exists in the database."""</span>
        <span class="k">return</span> <span class="n">_hash</span> <span class="ow">in</span> <span class="n">common</span><span class="o">.</span><span class="n">image_cache</span><span class="p">[</span><span class="n">cache_type</span><span class="p">]</span></div>

<div class="viewcode-block" id="ImageCache.value"><a class="viewcode-back" href="../../api/images.html#bookmarks.images.ImageCache.value">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="nb">hash</span><span class="p">,</span> <span class="n">cache_type</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">"""Get a value from the ImageCache.</span>

<span class="sd">        Args:</span>
<span class="sd">            hash (str): A hash value generated by `common.get_hash`</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="nb">hash</span><span class="p">,</span> <span class="n">cache_type</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">size</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">common</span><span class="o">.</span><span class="n">image_cache</span><span class="p">[</span><span class="n">cache_type</span><span class="p">][</span><span class="nb">hash</span><span class="p">]:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">common</span><span class="o">.</span><span class="n">image_cache</span><span class="p">[</span><span class="n">cache_type</span><span class="p">][</span><span class="nb">hash</span><span class="p">][</span><span class="n">size</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">common</span><span class="o">.</span><span class="n">image_cache</span><span class="p">[</span><span class="n">cache_type</span><span class="p">][</span><span class="nb">hash</span><span class="p">]</span></div>

<div class="viewcode-block" id="ImageCache.setValue"><a class="viewcode-back" href="../../api/images.html#bookmarks.images.ImageCache.setValue">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setValue</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="nb">hash</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">cache_type</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">"""Sets a value in the ImageCache using `hash` and the `cache_type`.</span>

<span class="sd">        If force is `True`, we will flush the sizes stored in the cache before</span>
<span class="sd">        setting the new value. This only applies to Image- and PixmapTypes.</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="nb">hash</span><span class="p">,</span> <span class="n">cache_type</span><span class="p">):</span>
            <span class="n">common</span><span class="o">.</span><span class="n">image_cache</span><span class="p">[</span><span class="n">cache_type</span><span class="p">][</span><span class="nb">hash</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">cache_type</span> <span class="o">==</span> <span class="n">BufferType</span><span class="p">:</span>
            <span class="n">common</span><span class="o">.</span><span class="n">check_type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">OpenImageIO</span><span class="o">.</span><span class="n">ImageBuf</span><span class="p">)</span>

            <span class="n">common</span><span class="o">.</span><span class="n">image_cache</span><span class="p">[</span><span class="n">BufferType</span><span class="p">][</span><span class="nb">hash</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">return</span> <span class="n">common</span><span class="o">.</span><span class="n">image_cache</span><span class="p">[</span><span class="n">BufferType</span><span class="p">][</span><span class="nb">hash</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">cache_type</span> <span class="o">==</span> <span class="n">ImageType</span><span class="p">:</span>
            <span class="n">common</span><span class="o">.</span><span class="n">check_type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QImage</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'Invalid size value.'</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

            <span class="n">common</span><span class="o">.</span><span class="n">image_cache</span><span class="p">[</span><span class="n">cache_type</span><span class="p">][</span><span class="nb">hash</span><span class="p">][</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">return</span> <span class="n">common</span><span class="o">.</span><span class="n">image_cache</span><span class="p">[</span><span class="n">cache_type</span><span class="p">][</span><span class="nb">hash</span><span class="p">][</span><span class="n">size</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">cache_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">PixmapType</span><span class="p">,</span> <span class="n">ResourcePixmapType</span><span class="p">):</span>
            <span class="n">common</span><span class="o">.</span><span class="n">check_type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPixmap</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

            <span class="n">common</span><span class="o">.</span><span class="n">image_cache</span><span class="p">[</span><span class="n">cache_type</span><span class="p">][</span><span class="nb">hash</span><span class="p">][</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">return</span> <span class="n">common</span><span class="o">.</span><span class="n">image_cache</span><span class="p">[</span><span class="n">cache_type</span><span class="p">][</span><span class="nb">hash</span><span class="p">][</span><span class="n">size</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">cache_type</span> <span class="o">==</span> <span class="n">ColorType</span><span class="p">:</span>
            <span class="n">common</span><span class="o">.</span><span class="n">check_type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">)</span>

            <span class="n">common</span><span class="o">.</span><span class="n">image_cache</span><span class="p">[</span><span class="n">ColorType</span><span class="p">][</span><span class="nb">hash</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">return</span> <span class="n">common</span><span class="o">.</span><span class="n">image_cache</span><span class="p">[</span><span class="n">ColorType</span><span class="p">][</span><span class="nb">hash</span><span class="p">]</span>

        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">'`cache_type` is invalid.'</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_color</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">common</span><span class="o">.</span><span class="n">check_type</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

        <span class="c1"># Check the cache and return the previously stored value if exists</span>
        <span class="n">_hash</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_hash</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">_hash</span><span class="p">,</span> <span class="n">ColorType</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">make_color</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">cls</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">_hash</span><span class="p">,</span> <span class="n">ColorType</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">_hash</span><span class="p">,</span> <span class="n">ColorType</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">cls</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">_hash</span><span class="p">,</span> <span class="n">ColorType</span><span class="p">)</span> <span class="ow">and</span> <span class="n">force</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">make_color</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="ImageCache.make_color"><a class="viewcode-back" href="../../api/images.html#bookmarks.images.ImageCache.make_color">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">make_color</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">"""Calculate the average color of a source image.</span>

<span class="sd">        Args:</span>
<span class="sd">            source (str): Path to an image file.</span>
<span class="sd">            hash (str, optional): Has value to use instead of source image's hash.</span>

<span class="sd">        Returns:</span>
<span class="sd">            QtGui.QImage: The average color of the source image.</span>

<span class="sd">        """</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">oiio_get_buf</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">buf</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">hash</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">hash</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_hash</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

        <span class="n">stats</span> <span class="o">=</span> <span class="n">OpenImageIO</span><span class="o">.</span><span class="n">ImageBufAlgo</span><span class="o">.</span><span class="n">computePixelStats</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stats</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">stats</span><span class="o">.</span><span class="n">avg</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">avg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">avg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">avg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">avg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span>
                <span class="n">a</span><span class="o">=</span><span class="mi">240</span>
                <span class="c1"># a=int(stats.avg[3] * 255)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">stats</span><span class="o">.</span><span class="n">avg</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">avg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">avg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">avg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">avg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">stats</span><span class="o">.</span><span class="n">avg</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">avg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">avg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">avg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">avg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="nb">hash</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">ColorType</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">color</span></div>

<div class="viewcode-block" id="ImageCache.resize_image"><a class="viewcode-back" href="../../api/images.html#bookmarks.images.ImageCache.resize_image">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">resize_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="sd">"""Returns a scaled copy of the image that fits in size.</span>

<span class="sd">        Args:</span>
<span class="sd">            image (QImage): The image to rescale.</span>
<span class="sd">            size (int): The size of the square to fit.</span>

<span class="sd">        Returns:</span>
<span class="sd">            QImage: The resized copy of the original image.</span>

<span class="sd">        """</span>
        <span class="n">common</span><span class="o">.</span><span class="n">check_type</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>
        <span class="n">common</span><span class="o">.</span><span class="n">check_type</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QImage</span><span class="p">)</span>

        <span class="n">w</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">width</span><span class="p">()</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">height</span><span class="p">()</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">*=</span> <span class="n">factor</span>
        <span class="n">h</span> <span class="o">*=</span> <span class="n">factor</span>
        <span class="k">return</span> <span class="n">image</span><span class="o">.</span><span class="n">smoothScaled</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">w</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">h</span><span class="p">))</span></div>

<div class="viewcode-block" id="ImageCache.get_rsc_pixmap"><a class="viewcode-back" href="../../api/images.html#bookmarks.images.ImageCache.get_rsc_pixmap">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_rsc_pixmap</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="n">common</span><span class="o">.</span><span class="n">GuiResource</span><span class="p">,</span>
                       <span class="n">get_path</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">"""Loads an image resource and returns it as a sized (and recolored) QPixmap.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str):         Name of the resource without the extension.</span>
<span class="sd">            color (QColor):     The colour of the icon.</span>
<span class="sd">            size (int):         The size of pixmap.</span>
<span class="sd">            opacity (float):    Sets the opacity of the returned pixmap.</span>
<span class="sd">            get_path (bool):    Returns the path to the image instead of a pixmap.</span>

<span class="sd">        Returns:</span>
<span class="sd">            QPixmap: The loaded image.</span>

<span class="sd">        """</span>
        <span class="n">common</span><span class="o">.</span><span class="n">check_type</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">common</span><span class="o">.</span><span class="n">check_type</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="n">source</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_rsc</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">resource</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">common</span><span class="o">.</span><span class="n">thumbnail_format</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">get_path</span><span class="p">:</span>
            <span class="n">file_info</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QFileInfo</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">file_info</span><span class="o">.</span><span class="n">absoluteFilePath</span><span class="p">()</span>

        <span class="n">_color</span> <span class="o">=</span> <span class="n">color</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">)</span> <span class="k">else</span> <span class="s1">'null'</span>
        <span class="n">k</span> <span class="o">=</span> <span class="s1">'rsc:'</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">':'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="p">))</span> <span class="o">+</span> <span class="s1">':'</span> <span class="o">+</span> <span class="n">_color</span>

        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">common</span><span class="o">.</span><span class="n">image_resource_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">common</span><span class="o">.</span><span class="n">image_resource_data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QImage</span><span class="p">()</span>
        <span class="n">image</span><span class="o">.</span><span class="n">setDevicePixelRatio</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">pixel_ratio</span><span class="p">)</span>
        <span class="n">image</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">isNull</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPixmap</span><span class="p">()</span>

        <span class="c1"># Do a re-color pass on the source image</span>
        <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">painter</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPainter</span><span class="p">()</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">setRenderHint</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QPainter</span><span class="o">.</span><span class="n">Antialiasing</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">setRenderHint</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QPainter</span><span class="o">.</span><span class="n">SmoothPixmapTransform</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">setCompositionMode</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QPainter</span><span class="o">.</span><span class="n">CompositionMode_SourceIn</span><span class="p">)</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">setBrush</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QBrush</span><span class="p">(</span><span class="n">color</span><span class="p">))</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">drawRect</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">rect</span><span class="p">())</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>

        <span class="n">image</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">resize_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">size</span> <span class="o">*</span> <span class="n">common</span><span class="o">.</span><span class="n">pixel_ratio</span><span class="p">)</span>
        <span class="n">image</span><span class="o">.</span><span class="n">setDevicePixelRatio</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">pixel_ratio</span><span class="p">)</span>

        <span class="c1"># Setting transparency</span>
        <span class="k">if</span> <span class="n">opacity</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">_image</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QImage</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="n">_image</span><span class="o">.</span><span class="n">setDevicePixelRatio</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">pixel_ratio</span><span class="p">)</span>
            <span class="n">_image</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">transparent</span><span class="p">)</span>

            <span class="n">painter</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPainter</span><span class="p">()</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="n">_image</span><span class="p">)</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">setOpacity</span><span class="p">(</span><span class="n">opacity</span><span class="p">)</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">drawImage</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">_image</span>

        <span class="c1"># Finally, we'll convert the image to a pixmap</span>
        <span class="n">pixmap</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPixmap</span><span class="p">()</span>
        <span class="n">pixmap</span><span class="o">.</span><span class="n">setDevicePixelRatio</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">pixel_ratio</span><span class="p">)</span>
        <span class="n">pixmap</span><span class="o">.</span><span class="n">convertFromImage</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">ColorOnly</span><span class="p">)</span>
        <span class="n">common</span><span class="o">.</span><span class="n">image_resource_data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixmap</span>
        <span class="k">return</span> <span class="n">common</span><span class="o">.</span><span class="n">image_resource_data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span></div>

<div class="viewcode-block" id="ImageCache.oiio_make_thumbnail"><a class="viewcode-back" href="../../api/images.html#bookmarks.images.ImageCache.oiio_make_thumbnail">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">oiio_make_thumbnail</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">nthreads</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">"""Converts the `source` image to an sRGB image fitting the bounds of `size` and saves it</span>
<span class="sd">        to `destination`.</span>

<span class="sd">        If size is `-1`, the image won't be resized.</span>

<span class="sd">        Args:</span>
<span class="sd">            source (str): Source image's file path.</span>
<span class="sd">            destination (str): Destination of the converted image.</span>
<span class="sd">            size (int): The bounds to fit the converted image (in pixels).</span>
<span class="sd">            nthreads (int): Number of threads to use. Defaults to 4.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if successfully converted the image, False otherwise.</span>

<span class="sd">        """</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">'Converting </span><span class="si">{}</span><span class="s1">...'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="p">),</span> <span class="bp">cls</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_scaled_spec</span><span class="p">(</span><span class="n">source_spec</span><span class="p">):</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">source_spec</span><span class="o">.</span><span class="n">width</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">source_spec</span><span class="o">.</span><span class="n">height</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">w</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
            <span class="n">w</span> <span class="o">*=</span> <span class="n">factor</span>
            <span class="n">h</span> <span class="o">*=</span> <span class="n">factor</span>

            <span class="n">s</span> <span class="o">=</span> <span class="n">OpenImageIO</span><span class="o">.</span><span class="n">ImageSpec</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="n">OpenImageIO</span><span class="o">.</span><span class="n">UINT8</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">channelnames</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'A'</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">alpha_channel</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">s</span><span class="o">.</span><span class="n">attribute</span><span class="p">(</span><span class="s1">'oiio:ColorSpace'</span><span class="p">,</span> <span class="s1">'sRGB'</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">attribute</span><span class="p">(</span><span class="s1">'oiio:Gamma'</span><span class="p">,</span> <span class="s1">'0.454545'</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">s</span>

        <span class="k">def</span> <span class="nf">shuffle_channels</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">source_spec</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">source_spec</span><span class="o">.</span><span class="n">nchannels</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="n">OpenImageIO</span><span class="o">.</span><span class="n">ImageBufAlgo</span><span class="o">.</span><span class="n">channels</span><span class="p">(</span>
                    <span class="n">buf</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">source_spec</span><span class="o">.</span><span class="n">channelnames</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">source_spec</span><span class="o">.</span><span class="n">channelnames</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                     <span class="n">source_spec</span><span class="o">.</span><span class="n">channelnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="p">(</span><span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">int</span><span class="p">(</span><span class="n">source_spec</span><span class="o">.</span><span class="n">nchannels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">source_spec</span><span class="o">.</span><span class="n">channelindex</span><span class="p">(</span><span class="s1">'A'</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">buf</span> <span class="o">=</span> <span class="n">OpenImageIO</span><span class="o">.</span><span class="n">ImageBufAlgo</span><span class="o">.</span><span class="n">channels</span><span class="p">(</span>
                        <span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'A'</span><span class="p">),</span> <span class="p">(</span><span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'A'</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">buf</span> <span class="o">=</span> <span class="n">OpenImageIO</span><span class="o">.</span><span class="n">ImageBufAlgo</span><span class="o">.</span><span class="n">channels</span><span class="p">(</span>
                        <span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">),</span> <span class="p">(</span><span class="s1">'R'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">buf</span>

        <span class="k">def</span> <span class="nf">resize</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">destination_spec</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">OpenImageIO</span><span class="o">.</span><span class="n">ImageBufAlgo</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span>
                <span class="n">buf</span><span class="p">,</span> <span class="n">roi</span><span class="o">=</span><span class="n">destination_spec</span><span class="o">.</span><span class="n">roi</span><span class="p">,</span> <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nthreads</span><span class="o">=</span><span class="n">nthreads</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">source_spec</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">source_spec</span><span class="o">.</span><span class="n">get_int_attribute</span><span class="p">(</span><span class="s1">'oiio:Movie'</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">buf</span>
            <span class="k">if</span> <span class="n">source_spec</span><span class="o">.</span><span class="n">deep</span><span class="p">:</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="n">OpenImageIO</span><span class="o">.</span><span class="n">ImageBufAlgo</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nthreads</span><span class="o">=</span><span class="n">nthreads</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">buf</span>

        <span class="k">def</span> <span class="nf">colorconvert</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">source_spec</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">source_spec</span><span class="o">.</span><span class="n">get_int_attribute</span><span class="p">(</span><span class="s1">'oiio:Movie'</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">buf</span>
            <span class="n">colorspace</span> <span class="o">=</span> <span class="n">source_spec</span><span class="o">.</span><span class="n">get_string_attribute</span><span class="p">(</span><span class="s1">'oiio:ColorSpace'</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">colorspace</span> <span class="o">==</span> <span class="s1">'linear'</span><span class="p">:</span>
                    <span class="n">buf</span> <span class="o">=</span> <span class="n">OpenImageIO</span><span class="o">.</span><span class="n">ImageBufAlgo</span><span class="o">.</span><span class="n">colorconvert</span><span class="p">(</span>
                        <span class="n">buf</span><span class="p">,</span> <span class="n">colorspace</span><span class="p">,</span> <span class="s1">'sRGB'</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">'Could not convert the color profile'</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">buf</span>

        <span class="n">buf</span> <span class="o">=</span> <span class="n">oiio_get_buf</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">buf</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">source_spec</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">spec</span><span class="p">()</span>

        <span class="c1"># The LibPNG seems to be fussy about corrupted and invalid ICC profiles and</span>
        <span class="c1"># OpenImageIO seems to interpret warning about these as errors that</span>
        <span class="c1"># bring python down. Removing the ICC profile seems to fix the issue.</span>
        <span class="k">if</span> <span class="n">source_spec</span><span class="o">.</span><span class="n">getattribute</span><span class="p">(</span><span class="s1">'ICCProfile'</span><span class="p">):</span>
            <span class="n">source_spec</span><span class="o">.</span><span class="n">erase_attribute</span><span class="p">(</span><span class="s1">'ICCProfile'</span><span class="p">)</span>

        <span class="c1"># if source_spec.get_int_attribute('oiio:Movie') == 1:</span>
        <span class="c1">#     codec_name = source_spec.get_string_attribute('ffmpeg:codec_name')</span>
        <span class="c1">#     # [BUG] Not all codec formats are supported by ffmpeg. There does</span>
        <span class="c1">#     # not seem to be (?) error handling and an unsupported codec will</span>
        <span class="c1">#     # crash ffmpeg and the rest of the app.</span>
        <span class="c1">#     if codec_name:</span>
        <span class="c1">#         if not [f for f in accepted_codecs if f.lower() in codec_name.lower()]:</span>
        <span class="c1">#             log.debug(</span>
        <span class="c1">#                 'Unsupported movie format: {codec_name}')</span>
        <span class="c1">#             common.oiio_cache.invalidate(source, force=True)</span>
        <span class="c1">#             return False</span>

        <span class="n">destination_spec</span> <span class="o">=</span> <span class="n">get_scaled_spec</span><span class="p">(</span><span class="n">source_spec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">size</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">resize</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">destination_spec</span><span class="p">)</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">shuffle_channels</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">source_spec</span><span class="p">)</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">flatten</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">source_spec</span><span class="p">)</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">colorconvert</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">source_spec</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">buf</span><span class="o">.</span><span class="n">nchannels</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">background_buf</span> <span class="o">=</span> <span class="n">OpenImageIO</span><span class="o">.</span><span class="n">ImageBuf</span><span class="p">(</span><span class="n">destination_spec</span><span class="p">)</span>
            <span class="n">OpenImageIO</span><span class="o">.</span><span class="n">ImageBufAlgo</span><span class="o">.</span><span class="n">checker</span><span class="p">(</span>
                <span class="n">background_buf</span><span class="p">,</span>
                <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                <span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">),</span>
                <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">OpenImageIO</span><span class="o">.</span><span class="n">ImageBufAlgo</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">background_buf</span><span class="p">)</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">spec</span><span class="p">()</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">set_write_format</span><span class="p">(</span><span class="n">OpenImageIO</span><span class="o">.</span><span class="n">UINT8</span><span class="p">)</span>

        <span class="c1"># On some dpx images I'm getting "GammaCorrectedinf"</span>
        <span class="k">if</span> <span class="s1">'gammacorrectedinf'</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">get_string_attribute</span><span class="p">(</span><span class="s1">'oiio:ColorSpace'</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">spec</span><span class="p">[</span><span class="s1">'oiio:ColorSpace'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'sRGB'</span>
            <span class="n">spec</span><span class="p">[</span><span class="s1">'oiio:Gamma'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'0.454545'</span>

        <span class="c1"># Initiating a new spec with the modified spec</span>
        <span class="c1"># _buf = OpenImageIO.ImageBuf(spec)</span>
        <span class="c1"># _buf.copy_pixels(buf)</span>
        <span class="c1"># _buf.set_write_format(OpenImageIO.UINT8)</span>

        <span class="c1"># Create a lock file before writing</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">destination</span> <span class="o">+</span> <span class="s1">'.lock'</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'utf8'</span><span class="p">)</span> <span class="k">as</span> <span class="n">_f</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">OpenImageIO</span><span class="o">.</span><span class="n">UINT8</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">destination</span> <span class="o">+</span> <span class="s1">'.lock'</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">buf</span><span class="o">.</span><span class="n">geterror</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">OpenImageIO</span><span class="o">.</span><span class="n">geterror</span><span class="p">()</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QFile</span><span class="p">(</span><span class="n">destination</span><span class="p">)</span><span class="o">.</span><span class="n">remove</span><span class="p">():</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">'Cleanup failed.'</span><span class="p">)</span>

            <span class="n">common</span><span class="o">.</span><span class="n">oiio_cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">common</span><span class="o">.</span><span class="n">oiio_cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div></div>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>

        <div class="related-information">
              Copyright &#169; 2021, Gergely Wootsch |
          Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
          <a href="https://github.com/pradyunsg/furo">Furo theme</a>.
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/scripts/furo.js"></script>
    </body>
</html>